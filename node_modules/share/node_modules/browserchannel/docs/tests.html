<!DOCTYPE html>  <html> <head>   <title>tests.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               tests.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Unit tests for BrowserChannel server</h1>

<p>This contains all the unit tests to make sure the server works like it should.</p>

<p>This is designed to be run using nodeunit. To run the tests, install nodeunit:</p>

<pre><code>npm install -g nodeunit
</code></pre>

<p>then run the tests with:</p>

<pre><code>nodeunit tests.coffee
</code></pre>

<p>I was thinking of using expresso for this, but I'd be starting up a server for
every test, and starting the servers in parallel means I might run into the
default open file limit (256 on macos) with all my tests. Its a shame too, because
nodeunit annoys me sometimes :)</p>

<p>It might be worth pulling in a higher level HTTP request library from somewhere.
interacting with HTTP using nodejs's http library is a bit lower level than I'd
like.</p>

<p>For now I'm not going to add in any SSL testing code. I should probably generate
a self-signed key pair, start the server using https and make sure that I can
still use it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">testCase</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;nodeunit&#39;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s1">&#39;connect&#39;</span>
<span class="nv">browserChannel = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib&#39;</span><span class="p">).</span><span class="nx">server</span>

<span class="nv">http = </span><span class="nx">require</span> <span class="s1">&#39;http&#39;</span>
<span class="p">{</span><span class="nx">parse</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;url&#39;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s1">&#39;assert&#39;</span>
<span class="nv">querystring = </span><span class="nx">require</span> <span class="s1">&#39;querystring&#39;</span>

<span class="nv">timer = </span><span class="nx">require</span> <span class="s1">&#39;timerstub&#39;</span>

<span class="nx">browserChannel</span><span class="p">.</span><span class="nx">_setTimerMethods</span> <span class="nx">timer</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Wait for the function to be called a given number of times, then call the callback.</p>

<p>This useful little method has been stolen from ShareJS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">expectCalls = </span><span class="nf">(n, callback) -&gt;</span>
	<span class="k">return</span> <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span>

	<span class="nv">remaining = </span><span class="nx">n</span>
	<span class="o">-&gt;</span>
		<span class="nx">remaining</span><span class="o">--</span>
		<span class="k">if</span> <span class="nx">remaining</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="nx">callback</span><span class="p">()</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">remaining</span> <span class="o">&lt;</span> <span class="mi">0</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;expectCalls called more than #{n} times&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This returns a function that calls test.done() after it has been called n times. Its
useful when you want a bunch of mini tests inside one test case.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">makePassPart = </span><span class="nf">(test, n) -&gt;</span>
	<span class="nx">expectCalls</span> <span class="nx">n</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Most of these tests will make HTTP requests. A lot of the time, we don't care about the
timing of the response, we just want to know what it was. This method will buffer the
response data from an http response object and when the whole response has been received,
send it on.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buffer = </span><span class="nf">(res, callback) -&gt;</span>
	<span class="nv">data = </span><span class="p">[]</span>
	<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>console.warn chunk.toString()</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
	<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nx">data</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>For some tests we expect certain data, delivered in chunks. Wait until we've
received at least that much data and strcmp. The response will probably be used more,
afterwards, so we'll make sure the listener is removed after we're done.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">expect = </span><span class="nf">(res, str, callback) -&gt;</span>
	<span class="nv">data = </span><span class="s1">&#39;&#39;</span>
	<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nv">endlistener = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This should fail - if the data was as long as str, we would have compared them
already. Its important that we get an error message if the http connection ends
before the string has been received.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span> <span class="s1">&#39;Connection ended prematurely&#39;</span>
		<span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">str</span>

	<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">listener = </span><span class="nf">(chunk) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>I'm using string += here because the code is easier that way.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">data</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>console.warn JSON.stringify data
console.warn JSON.stringify str</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
			<span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">str</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">listener</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">endlistener</span>
			<span class="nx">callback</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The backchannel is implemented using a bunch of messages which look like this:</p>

<p><code>
36
[[0,["c","92208FBF76484C10",,8]
]
]
</code></p>

<p>They have a length string (in bytes) followed by some JSON data. Google's
implementation doesn't use strict JSON encoding (like above). They can optionally
have extra chunks.</p>

<p>This format is used for:</p>

<ul>
<li>All XHR backchannel messages</li>
<li>The response to the initial connect (XHR or HTTP)</li>
<li>The server acknowledgement to forward channel messages</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">readLengthPrefixedJSON = </span><span class="nf">(res, callback) -&gt;</span>
	<span class="nv">data = </span><span class="s1">&#39;&#39;</span>
	<span class="nv">length = </span><span class="kc">null</span>
	<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">listener = </span><span class="nf">(chunk) -&gt;</span>
		<span class="nx">data</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>

		<span class="k">if</span> <span class="nx">length</span> <span class="o">==</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The number of bytes is written in an int on the first line.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">lines = </span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;\n&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If lines length > 1, then we've read the first newline, which was after the length
field.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
				<span class="nv">length = </span><span class="nb">parseInt</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Now we'll rewrite the data variable to not include the length.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">data = </span><span class="nx">lines</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;\n&#39;</span>

		<span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">length</span>
			<span class="nv">obj = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">listener</span>
			<span class="nx">callback</span> <span class="nx">obj</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">length</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Read more bytes from stream than expected&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Copied from google's implementation. The contents of this aren't actually relevant,
but I think its important that its pseudo-random so if the connection is compressed,
it still recieves a bunch of bytes after the first message.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ieJunk = </span><span class="s2">&quot;7cca69475363026330a0d99468e88d23ce95e222591126443015f5f462d9a177186c8701fb45a6ffe</span>
<span class="s2">e0daf1a178fc0f58cd309308fba7e6f011ac38c9cdd4580760f1d4560a84d5ca0355ecbbed2ab715a3350fe0c47</span>
<span class="s2">9050640bd0e77acec90c58c4d3dd0f5cf8d4510e68c8b12e087bd88cad349aafd2ab16b07b0b1b8276091217a44</span>
<span class="s2">a9fe92fedacffff48092ee693af\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Most tests will just use the default configuration of browserchannel, but obviously
some tests will need to customise the options. To customise the options we'll need
to create a new server object.</p>

<p>So, the code to create servers has been pulled out here for use in tests.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">createServer = </span><span class="nf">(opts, method, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Its possible to use the browserChannel middleware without specifying an options
object. This little createServer function will mirror that behaviour.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="k">typeof</span> <span class="nx">opts</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
		<span class="nv">callback = </span><span class="nx">method</span>
		<span class="nv">method = </span><span class="nx">opts</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>I want to match up with how its actually going to be used.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">bc = </span><span class="nx">browserChannel</span> <span class="nx">method</span>
	<span class="k">else</span>
		<span class="nv">bc = </span><span class="nx">browserChannel</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">method</span>
	</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The server is created using connect middleware. I'll simulate other middleware in
the stack by adding a second handler which responds with 200, 'Other middleware' to
any request.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">server = </span><span class="nx">connect</span> <span class="nx">bc</span><span class="p">,</span> <span class="nf">(req, res, next) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>I might not actually need to specify the headers here... (If you don't, nodejs provides
some defaults).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s1">&#39;Other middleware&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Calling server.listen() without a port lets the OS pick a port for us. I don't
know why more testing frameworks don't do this by default.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Obviously, we need to know the port to be able to make requests from the server.
The callee could check this itself using the server object, but it'll always need
to know it, so its easier pulling the port out here.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">port = </span><span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span>
		<span class="nx">callback</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">port</span>

<span class="nv">module.exports = </span><span class="nx">testCase</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h4>setUp</h4>

<p>Before each test has run, we'll start a new server. The server will only live
for that test and then it'll be torn down again.</p>

<p>This makes the tests run more slowly, but not slowly enough that I care.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">setUp: </span><span class="nf">(callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>When you instantiate browserchannel, you specify a function which gets called
with each client that connects. I'll proxy that function call to a local function
which tests can override.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@onClient = </span><span class="nf">(client) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>The proxy is inline here. Also, I &lt;3 coffeescript's (@server, @port) -> syntax here.
That will automatically set this.server and this.port to the callback arguments.</p>

<p>Actually calling the callback starts the test.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">createServer</span> <span class="p">((</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@onClient</span> <span class="nx">client</span><span class="p">),</span> <span class="p">(</span><span class="nx">@server</span><span class="p">,</span> <span class="nx">@port</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>I'll add a couple helper methods for tests to easily message the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="vi">@get = </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="p">{</span><span class="nx">host</span><span class="o">:</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">@port</span><span class="p">},</span> <span class="nx">callback</span>

			<span class="vi">@post = </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nv">req = </span><span class="nx">http</span><span class="p">.</span><span class="nx">request</span> <span class="p">{</span><span class="nx">method</span><span class="o">:</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">host</span><span class="o">:</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">@port</span><span class="p">},</span> <span class="nx">callback</span>
				<span class="nx">req</span><span class="p">.</span><span class="nx">end</span> <span class="nx">data</span>

			<span class="nx">callback</span><span class="p">()</span>

	<span class="nv">tearDown: </span><span class="nf">(callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h4>tearDown</h4>

<p>This is called after each tests is done. We'll tear down the server we just created.</p>

<p>The next test is run once the callback is called. I could probably chain the next
test without waiting for close(), but then its possible that an exception thrown
in one test will appear after the next test has started running. Its easier to debug
like this.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@server</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">callback</span>
		<span class="nx">@server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h1>Testing channel tests</h1>

<p>The first thing a client does when it connects is issue a GET on /test/?mode=INIT.
The server responds with an array of [basePrefix or null,blockedPrefix or null]. Blocked
prefix isn't supported by node-browerchannel and by default no basePrefix is set. So with no
options specified, this GET should return [null,null].</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;GET /test/?mode=INIT with no baseprefix set returns [null, null]&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@get</span> <span class="s1">&#39;/channel/test?VER=8&amp;MODE=init&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
			<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;[null,null]&#39;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If a basePrefix is set in the options, make sure the server returns it.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;GET /test/?mode=INIT with a basePrefix set returns [basePrefix, null]&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>You can specify a bunch of host prefixes. If you do, the server will randomly pick between them.
I don't know if thats actually useful behaviour, but <em>shrug</em>
I should probably write a test to make sure all host prefixes will be chosen from time to time.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">createServer</span> <span class="nx">hostPrefixes</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;chan&#39;</span><span class="p">],</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">),</span> <span class="nf">(server, port) -&gt;</span>
			<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span><span class="s1">&#39;/channel/test?VER=8&amp;MODE=init&#39;</span><span class="p">,</span> <span class="nv">host: </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">},</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
				<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;[&quot;chan&quot;,null]&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>I'm being slack here - the server might not close immediately. I could make test.done()
dependant on it, but I can't be bothered.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Setting a custom url endpoint to bind node-browserchannel to should make it respond at that url endpoint
only.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The test channel responds at a bound custom endpoint&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">createServer</span> <span class="nx">base</span><span class="o">:</span><span class="s1">&#39;/foozit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">),</span> <span class="nf">(server, port) -&gt;</span>
			<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span><span class="s1">&#39;/foozit/test?VER=8&amp;MODE=init&#39;</span><span class="p">,</span> <span class="nv">host: </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">},</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
				<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;[null,null]&#39;</span>
					<span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Some people will miss out on the leading slash in the URL when they bind browserchannel to a custom
url. That should work too.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;binding the server to a custom url without a leading slash works&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">createServer</span> <span class="nx">base</span><span class="o">:</span><span class="s1">&#39;foozit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">),</span> <span class="nf">(server, port) -&gt;</span>
			<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span><span class="s1">&#39;/foozit/test?VER=8&amp;MODE=init&#39;</span><span class="p">,</span> <span class="nv">host: </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">},</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
				<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;[null,null]&#39;</span>
					<span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Its tempting to think that you need a trailing slash on your URL prefix as well. You don't, but that should
work too.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;binding the server to a custom url with a trailing slash works&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Some day, the copy+paste police are gonna get me. I don't feel <em>so</em> bad doing it for tests though, because
it helps readability.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">createServer</span> <span class="nx">base</span><span class="o">:</span><span class="s1">&#39;foozit/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">),</span> <span class="nf">(server, port) -&gt;</span>
			<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span><span class="s1">&#39;/foozit/test?VER=8&amp;MODE=init&#39;</span><span class="p">,</span> <span class="nv">host: </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">},</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
				<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;[null,null]&#39;</span>
					<span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>node-browserchannel is only responsible for URLs with the specified (or default) prefix. If a request
comes in for a URL outside of that path, it should be passed along to subsequent connect middleware.</p>

<p>I've set up the createServer() method above to send 'Other middleware' if browserchannel passes
the response on to the next handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;getting a url outside of the bound range gets passed to other middleware&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@get</span> <span class="s1">&#39;/otherapp&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
			<span class="nx">buffer</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;Other middleware&#39;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>I decided to make URLs inside the bound range return 404s directly. I can't guarantee that no future
version of node-browserchannel won't add more URLs in the zone, so its important that users don't decide
to start using arbitrary other URLs under channel/.</p>

<p>That design decision makes it impossible to add a custom 404 page to /channel/FOO, but I don't think thats a
big deal.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;getting a wacky url inside the bound range returns 404&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@get</span> <span class="s1">&#39;/channel/doesnotexist&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">404</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>Testing phase 2</h2>

<p>I should really sort the above tests better.</p>

<p>Testing phase 2 the client GETs /channel/test?VER=8&amp;TYPE= [html / xmlhttp] &amp;zx=558cz3evkwuu&amp;t=1 [&amp;DOMAIN=xxxx]</p>

<p>The server sends '11111' &lt;2 second break> '2'. If you use html encoding instead, the server sends the client
a webpage which calls:</p>

<pre><code>document.domain='mail.google.com';
parent.m('11111');
parent.m('2');
parent.d();
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;Getting test phase 2 returns 11111 then 2&#39;</span><span class="o">:</span> <span class="nx">do</span> <span class="o">-&gt;</span>
		<span class="nv">makeTest = </span><span class="nf">(type, message1, message2) -&gt;</span> <span class="nf">(test) -&gt;</span>
			<span class="nx">@get</span> <span class="s2">&quot;/channel/test?VER=8&amp;TYPE=#{type}&quot;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">200</span>
				<span class="nx">expect</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">message1</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Its important to make sure that message 2 isn't sent too soon (&lt;2 seconds).
We'll advance the server's clock forward by just under 2 seconds and then wait a little bit
for messages from the client. If we get a message during this time, throw an error.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">f = </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;should not get more data so early&#39;</span>
					<span class="nx">timer</span><span class="p">.</span><span class="nx">wait</span> <span class="mi">1999</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>This is the real <code>setTimeout</code> method here. We'll wait 50 milliseconds, which should be way
more than enough to get a response from a local server, if its going to give us one.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">setTimeout</span> <span class="o">-&gt;</span>
								<span class="nx">response</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">f</span>
								<span class="nx">timer</span><span class="p">.</span><span class="nx">wait</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-&gt;</span>
									<span class="nx">expect</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">message2</span><span class="p">,</span> <span class="o">-&gt;</span>
										<span class="nx">response</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
							<span class="p">,</span> <span class="mi">50</span>

		<span class="s1">&#39;xmlhttp&#39;</span><span class="o">:</span> <span class="nx">makeTest</span> <span class="s1">&#39;xmlhttp&#39;</span><span class="p">,</span> <span class="s1">&#39;11111&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>I could write this test using JSDom or something like that, and parse out the HTML correctly.
... but it would be way more complicated (and no more correct) than simply comparing the resulting
strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="s1">&#39;html&#39;</span><span class="o">:</span> <span class="nx">makeTest</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>These HTML responses are identical to what I'm getting from google's servers. I think the seemingly
random sequence is just so network framing doesn't try and chunk up the first packet sent to the server
or something like that.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try {parent.m(&quot;</span><span class="mi">11111</span><span class="s2">&quot;)} catch(e) {}&lt;/script&gt;\n#{ieJunk}&quot;&quot;&quot;</span><span class="p">,</span>
			<span class="s1">&#39;&#39;&#39;&lt;script&gt;try {parent.m(&quot;2&quot;)} catch(e) {}&lt;/script&gt;</span>
<span class="s1">&lt;script&gt;try  {parent.d(); }catch (e){}&lt;/script&gt;\n&#39;&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If a client is connecting with a host prefix, the server sets the iframe's document.domain to match
before sending actual data.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="s1">&#39;html with a host prefix&#39;</span><span class="o">:</span> <span class="nx">makeTest</span><span class="p">(</span><span class="s1">&#39;html&amp;DOMAIN=foo.bar.com&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>I've made a small change from google's implementation here. I'm using double quotes <code>"</code> instead of
single quotes <code>'</code> because its easier to encode. (I can't just wrap the string in quotes because there
are potential XSS vulnerabilities if I do that).</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try{document.domain=&quot;</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">com</span><span class="s2">&quot;;}catch(e){}&lt;/script&gt;</span>
<span class="s2">&lt;script&gt;try {parent.m(&quot;</span><span class="mi">11111</span><span class="s2">&quot;)} catch(e) {}&lt;/script&gt;\n#{ieJunk}&quot;&quot;&quot;</span><span class="p">,</span>
			<span class="s1">&#39;&#39;&#39;&lt;script&gt;try {parent.m(&quot;2&quot;)} catch(e) {}&lt;/script&gt;</span>
<span class="s1">&lt;script&gt;try  {parent.d(); }catch (e){}&lt;/script&gt;\n&#39;&#39;&#39;</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>node-browserchannel is only compatible with browserchannel client v8. I don't know whats changed
since old versions (maybe v6 would be easy to support) but I don't care. If the client specifies
an old version, we'll die with an error.
The alternate phase 2 URL style should have the same behaviour if the version is old or unspecified.</p>

<p>Google's browserchannel server still works if you miss out on specifying the version - it defaults
to version 1 (which maybe didn't have version numbers in the URLs). I'm kind of impressed that
all that code still works.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;Getting /test/* without VER=8 returns an error&#39;</span><span class="o">:</span> <span class="nx">do</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>All these tests look 95% the same. Instead of writing the same test all those times, I'll use this
little helper method to generate them.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">check400 = </span><span class="nf">(path) -&gt;</span> <span class="nf">(test) -&gt;</span>
			<span class="nx">@get</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="mi">400</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

		<span class="s1">&#39;phase 1, ver 7&#39;</span><span class="o">:</span> <span class="nx">check400</span> <span class="s1">&#39;/channel/test?VER=7&amp;MODE=init&#39;</span>
		<span class="s1">&#39;phase 1, no version&#39;</span><span class="o">:</span> <span class="nx">check400</span> <span class="s1">&#39;/channel/test?MODE=init&#39;</span>
		<span class="s1">&#39;phase 2, ver 7, xmlhttp&#39;</span><span class="o">:</span> <span class="nx">check400</span> <span class="s1">&#39;/channel/test?VER=7&amp;TYPE=xmlhttp&#39;</span>
		<span class="s1">&#39;phase 2, no version, xmlhttp&#39;</span><span class="o">:</span> <span class="nx">check400</span> <span class="s1">&#39;/channel/test?TYPE=xmlhttp&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>For HTTP connections (IE), the error is sent a different way. Its kinda complicated how the error
is sent back, so for now I'm just going to ignore checking it.
<code>'phase 2, ver 7, http': check400 '/channel/test?VER=7&amp;TYPE=html'</code>
<code>'phase 2, no version, http': check400 '/channel/test?TYPE=html'</code></p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <blockquote>
  <p>At the moment the server expects the client will add a zx=###### query parameter to all requests.
  The server isn't strict about this, so I'll ignore it in the tests for now.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h1>Server connection tests</h1>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>These tests make pretend client connections by crafting raw HTTP queries. I'll make another set of
tests later which spam the server with a million fake clients.</p>

<p>To start with, simply connect to a server using the BIND API. A client sends a server a few parameters:</p>

<ul>
<li><strong>CVER</strong>: Client application version</li>
<li><strong>RID</strong>: Client-side generated random number, which is the initial sequence number for the
client's requests.</li>
<li><strong>VER</strong>: Browserchannel protocol version. Must be 8.</li>
<li><strong>t</strong>: The connection attempt number. This is currently ignored by the BC server. (I'm not sure
what google's implementation does with this).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;A client connects if it POSTs the right connection stuff&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nv">id = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>When a client request comes in, we should get a connected client through the browserchannel
server API.</p>

<p>We need this client in order to find out the client's ID, which should match up with part of the
server's response.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@onClient = </span><span class="nf">(client) -&gt;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">ok</span> <span class="nx">client</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="k">typeof</span> <span class="nx">client</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">client</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">client</span><span class="p">.</span><span class="nx">appVersion</span><span class="p">,</span> <span class="s1">&#39;99&#39;</span>
			<span class="nv">id = </span><span class="nx">client</span><span class="p">.</span><span class="nx">id</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Should not have received data&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The client starts a BC connection by POSTing to /bind? with no session ID specified.
The client can optionally send data here, but in this case it won't (hence the <code>count=0</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;CVER=99&amp;t=1&amp;junk=asdfasdf&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nv">expected = </span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]])</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span>
			<span class="nx">buffer</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Even for old IE clients, the server responds in length-prefixed JSON style.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s2">&quot;#{expected.length}\n#{expected}&quot;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">expect</span> <span class="mi">5</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>The CVER= property is optional during client connections. If its left out, client.appVersion is
null.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;A client connects ok even if it doesnt specify an app version&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nv">id = </span><span class="kc">null</span>
		<span class="vi">@onClient = </span><span class="nf">(client) -&gt;</span>
			<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">client</span><span class="p">.</span><span class="nx">appVersion</span><span class="p">,</span> <span class="kc">null</span>
			<span class="nv">id = </span><span class="nx">client</span><span class="p">.</span><span class="nx">id</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Should not have received data&#39;</span>

		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&amp;junk=asdfasdf&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nv">expected = </span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]])</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span>
			<span class="nx">buffer</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="s2">&quot;#{expected.length}\n#{expected}&quot;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">expect</span> <span class="mi">2</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>This time, we'll send a map to the server during the initial handshake. This should be received
by the server as normal.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The client can post messages to the server during initialization&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="vi">@onClient = </span><span class="nf">(client) -&gt;</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="nx">k</span><span class="o">:</span><span class="s1">&#39;v&#39;</span><span class="p">}</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_k=v&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>The data received by the server should be properly URL decoded and whatnot.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The client can post messages to the server during initialization&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="vi">@onClient = </span><span class="nf">(client) -&gt;</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;_int_^&amp;^%#net&quot;</span><span class="o">:</span><span class="s1">&#39;hi&quot;there&amp;&amp;\nsam&#39;</span><span class="p">}</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

		<span class="nx">@post</span><span class="p">(</span><span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span>
			<span class="s1">&#39;count=1&amp;ofs=0&amp;req0__int_%5E%26%5E%25%23net=hi%22there%26%26%0Asam&#39;</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>After a client connects, it can POST data to the server using URL-encoded POST data. This data
is sent by POSTing to /bind?SID=....</p>

<p>The data looks like this:</p>

<p>count=5&amp;ofs=1000&amp;req0<em>KEY1=VAL1&amp;req0</em>KEY2=VAL2&amp;req1<em>KEY3=req1</em>VAL3&amp;...</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The client can post messages to the server after initialization&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="nx">k</span><span class="o">:</span><span class="s1">&#39;v&#39;</span><span class="p">}</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

			<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_k=v&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>When the server gets a forwardchannel request, it should reply with a little array saying whats
going on.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server acknowledges forward channel messages correctly&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_k=v&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>The server responds with [backchannelMissing ? 0 : 1, lastSentAID, outstandingBytes]</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>If the server has an active backchannel, it responds to forward channel requests notifying the client
that the backchannel connection is alive and well.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server tells the client if the backchannel is alive&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>This will fire up a backchannel connection to the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>The client shouldn't get any data through the backchannel.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Should not get data through backchannel&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Unfortunately, the GET request is sent <em>after</em> the POST, so we have to wrap the
post in a timeout to make sure it hits the server after the backchannel connection is
established.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setTimeout</span> <span class="o">=&gt;</span>
					<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_k=v&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
						<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>This time, we get a 1 as the first argument because the backchannel connection is
established.</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>The backchannel hasn't gotten any data yet. It'll spend 15 seconds or so timing out
if we don't abort it manually.</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
							<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
				<span class="p">,</span> <span class="mi">50</span>
	</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>When the user calls send(), data is queued by the server and sent into the next backchannel connection.</p>

<p>The server will use the initial establishing connection if thats available, or it'll send it the next
time the client opens a backchannel connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server returns data on the initial connection when send is called immediately&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span>

		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">@client</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">testData</span><span class="p">]]</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>


	<span class="s1">&#39;The server buffers data if no backchannel is available&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>The first response to the server is sent after this method returns, so if we send the data
in process.nextTick, it'll get buffered.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span>

				<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
						<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">testData</span><span class="p">]]</span>
						<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
						<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>This time, we'll fire up the back channel first (and give it time to get established) <em>then</em>
send data through the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server returns data through the available backchannel when send is called later&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Fire off the backchannel request as soon as the client has connected</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>res.on 'data', (chunk) -> console.warn chunk.toString()</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">testData</span><span class="p">]]</span>
					<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Send the data outside of the get block to make sure it makes it through.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span><span class="p">),</span> <span class="mi">50</span>
	</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>If there's a proxy in the way which chunks up responses before sending them on, the client adds a
&amp;CI=1 argument on the backchannel. This causes the server to end the HTTP query after each message
is sent, so the data is sent to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The backchannel is closed after each packet if chunking is turned off&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Instead of the usual CI=0 we're passing CI=1 here.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
						<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">testData</span><span class="p">]]</span>

					<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Normally, the server doesn't close the connection after each backchannel message.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The backchannel is left open if CI=0&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span>

				<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
						<span class="nx">test</span><span class="p">.</span><span class="nx">deepEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">testData</span><span class="p">]]</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>After receiving the data, the client must not close the connection. (At least, not unless
it times out naturally)</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;connection should have stayed open&#39;</span>

					<span class="nx">setTimeout</span> <span class="o">-&gt;</span>
							<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
							<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
						<span class="p">,</span> <span class="mi">50</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>On IE, the data is all loaded using iframes. The backchannel spits out data using inline scripts
in an HTML page.</p>

<p>I've written this test separately from the tests above, but it would really make more sense
to rerun the same set of tests in both HTML and XHR modes to make sure the behaviour is correct
in both instances.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server gives the client correctly formatted backchannel data if TYPE=html&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>The type is specified as an argument here in the query string. For this test, I'm making
CI=1, because the test is easier to write that way.</p>

<p>In truth, I don't care about IE support as much as support for modern browsers. This might
be a mistake.. I'm not sure. IE9's XHR support should work just fine for browserchannel,
though google's BC client doesn't use it.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=html&amp;CI=1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">expect</span> <span class="nx">res</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Interestingly, google doesn't double-encode the string like this. Instead of turning
quotes <code>"</code> into escaped quotes <code>\"</code>, it uses unicode encoding to turn them into \42 and
stuff like that. I'm not sure why they do this - it produces the same effect in IE8.
I should test it in IE6 and see if there's any problems.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try {parent.m(#{JSON.stringify JSON.stringify([[1, testData]]) + &#39;\n&#39;})} catch(e) {}&lt;/script&gt;</span>
<span class="s2">#{ieJunk}&lt;script&gt;try  {parent.d(); }catch (e){}&lt;/script&gt;\n&quot;&quot;&quot;</span><span class="p">,</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Because I'm lazy, I'm going to chain on a test to make sure CI=0 works as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nv">data2 = </span><span class="p">{</span><span class="nx">other</span><span class="o">:</span><span class="s1">&#39;data&#39;</span><span class="p">}</span>
							<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data2</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>I'm setting AID=1 here to indicate that the client has seen array 1.</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=1&amp;TYPE=html&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
								<span class="nx">expect</span> <span class="nx">res</span><span class="p">,</span>
									<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try {parent.m(#{JSON.stringify JSON.stringify([[2, data2]]) + &#39;\n&#39;})} catch(e) {}&lt;/script&gt;</span>
<span class="s2">#{ieJunk}&quot;&quot;&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
										<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
										<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>If there's a basePrefix set, the returned HTML sets <code>document.domain =</code> before sending messages.
I'm super lazy, and just copy+pasting from the test above. There's probably a way to factor these tests
nicely, but I'm not in the mood to figure it out at the moment.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server sets the domain if we have a domain set&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>This time we're setting DOMAIN=X, and the response contains a document.domain= block. Woo.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=html&amp;CI=1&amp;DOMAIN=foo.com&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">expect</span> <span class="nx">res</span><span class="p">,</span>
						<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try{document.domain=\&quot;foo.com\&quot;;}catch(e){}&lt;/script&gt;</span>
<span class="s2">&lt;script&gt;try {parent.m(#{JSON.stringify JSON.stringify([[1, testData]]) + &#39;\n&#39;})} catch(e) {}&lt;/script&gt;</span>
<span class="s2">#{ieJunk}&lt;script&gt;try  {parent.d(); }catch (e){}&lt;/script&gt;\n&quot;&quot;&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
							<span class="nv">data2 = </span><span class="p">{</span><span class="nx">other</span><span class="o">:</span><span class="s1">&#39;data&#39;</span><span class="p">}</span>
							<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data2</span>
							<span class="nv">req = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=1&amp;TYPE=html&amp;CI=0&amp;DOMAIN=foo.com&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
								<span class="nx">expect</span> <span class="nx">res</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Its interesting - in the test channel, the ie junk comes right after the document.domain= line,
but in a backchannel like this it comes after. The behaviour here is the same in google's version.</p>

<p>I'm not sure if its actually significant though.</p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;script&gt;try{document.domain=\&quot;foo.com\&quot;;}catch(e){}&lt;/script&gt;</span>
<span class="s2">&lt;script&gt;try {parent.m(#{JSON.stringify JSON.stringify([[2, data2]]) + &#39;\n&#39;})} catch(e) {}&lt;/script&gt;</span>
<span class="s2">#{ieJunk}&quot;&quot;&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
										<span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
										<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>If a client thinks their backchannel connection is closed, they might open a second backchannel connection.
In this case, the server should close the old one and resume sending stuff using the new connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server closes old backchannel connections&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
		<span class="nv">testData = </span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;there&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">555</span><span class="p">]]</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">@client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">@client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">testData</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>As usual, we'll get the sent data through the backchannel connection. The connection is kept open...</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>... and the data has been read. Now we'll open another connection and check that the first connection
gets closed.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nv">req2 = </span><span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=1&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res2</span><span class="p">)</span> <span class="o">=&gt;</span>

						<span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
							<span class="nx">req2</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
							<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>The client attaches a sequence number (<em>RID</em>) to every message, to make sure they don't end up out-of-order at
the server's end.</p>

<p>We'll purposefully send some messages out of order and make sure they're held and passed through in order.</p>

<p>Gogo gadget reimplementing TCP.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server orders forwardchannel messages correctly using RIDs&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>The initial sequence number is 1000...</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>We'll send 2 maps, the first one will be {v:1} then {v:0}. They should be swapped around by the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">lastVal = </span><span class="mi">0</span>
		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nf">(map) -&gt;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">map</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="s2">&quot;#{lastVal++}&quot;</span><span class="p">,</span> <span class="s1">&#39;messages arent reordered in the server&#39;</span>
				<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span> <span class="k">if</span> <span class="nx">map</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span>
		</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>First, send <code>[{v:2}]</code></p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1002&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=2&amp;req0_v=2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>... then <code>[{v:0}, {v:1}]</code> a few MS later.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setTimeout</span> <span class="o">=&gt;</span>
					<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=2&amp;ofs=0&amp;req0_v=0&amp;req1_v=1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="p">,</span> <span class="mi">50</span>
	
	<span class="s1">&#39;Repeated forward channel messages are discarded&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nv">gotMessage = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>The map must only be received once.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nf">(map) -&gt;</span>
				<span class="k">if</span> <span class="nx">gotMessage</span> <span class="o">==</span> <span class="kc">false</span>
					<span class="nv">gotMessage = </span><span class="kc">true</span>
				<span class="k">else</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;got map twice&#39;</span>
		</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>POST the maps twice.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_v=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">@post</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=1001&amp;SID=#{client.id}&amp;AID=0&quot;</span><span class="p">,</span> <span class="s1">&#39;count=1&amp;ofs=0&amp;req0_v=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Wait 50 milliseconds for the map to (maybe!) be received twice, then pass.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setTimeout</span> <span class="o">-&gt;</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">gotMessage</span><span class="p">,</span> <span class="kc">true</span>
					<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
				<span class="p">,</span> <span class="mi">50</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>With each request to the server, the client tells the server what array it saw last through the AID= parameter.</p>

<p>If a client sends a subsequent backchannel request with an old AID= set, that means the client never saw the arrays
the server has previously sent. So, the server should resend them.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;The server resends lost arrays if the client asks for them&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span>
		<span class="nx">@post</span> <span class="s1">&#39;/channel/bind?VER=8&amp;RID=1000&amp;t=1&#39;</span><span class="p">,</span> <span class="s1">&#39;count=0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>

		<span class="vi">@onClient = </span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
				<span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
				<span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

				<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=0&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
					<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
						<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]]</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>We'll resend that request, pretending that the client never saw the second array sent (<code>[4,5,6]</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">@get</span> <span class="s2">&quot;/channel/bind?VER=8&amp;RID=rpc&amp;SID=#{client.id}&amp;AID=1&amp;TYPE=xmlhttp&amp;CI=0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
							<span class="nx">readLengthPrefixedJSON</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
								<span class="nx">test</span><span class="p">.</span><span class="nx">strictEqual</span> <span class="nx">data</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]]</span>
								<span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;If a client disconnects then reconnects, specifying OSID= and OAID=, the local client doesnt notice&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;If a client reconnects, the server resends any messages the client did not receive&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;client.stop() sends stop to a client&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;After stop() is called, no maps are emitted by the client&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;client.close() makes subsequent client messages return an error&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;The client times out after awhile&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;The server sends heartbeat messages on the backchannel, which keeps it open&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;If a client times out, unacknowledged messages have an error callback called&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;The server sends accept:JSON header&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>

	<span class="s1">&#39;The server accepts JSON data&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span>
	
	<span class="s1">&#39;Connecting with a version thats not 8 breaks&#39;</span><span class="o">:</span> <span class="nf">(test) -&gt;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>server = connect browserChannel (client) ->
if client.address != '127.0.0.1' or client.appVersion != '10'
    client.stop()</p>

<p>client.on 'map', (data) ->
    console.log data</p>

<p>client.send ['hi']</p>

<p>setInterval (-> client.send ['yo dawg']), 3000</p>

<p>client.on 'reconnected', (oldSessionId) -></p>

<p>client.on 'destroyed', ->
Clean up
server.listen(4321)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h1>Tests</h1>

<p>The browserchannel service exposes 2 API endpoints</p>

<h2>Test Service</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 